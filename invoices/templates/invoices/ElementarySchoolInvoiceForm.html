<!DOCTYPE html>

<html lang="fa">
<head>
    {% load static %}
    {% csrf_token %}
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>فرم اطلاعات فاکتورها (دبستان)</title> 
<!--     <link href="https://fonts.googleapis.com/css2?family=Vazir&display=swap" rel="stylesheet"> -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
  
    <link
      rel="stylesheet"
 href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
      <script
        type="text/javascript"
        src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"
    ></script>
    <script src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>

      <script src="{% static 'SheetScript.js' %}"></script>

      <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">
    
    <style>
      
        :root {
            --primary-color: #4CAF50;
            --hover-primary-color: #228B22;
            --danger-color: #f44336;
            --hover-danger-color: #d32f2f;
            --background-color: #1e1e1e;
            --card-background: rgba(255, 255, 255, 0.1);
            --item-background: rgba(255, 255, 255, 0.05);
            --white-color: #ffffff;
            --border-color: #444;
        }

      body {
          font-family: 'Amiri', sans-serif;
          font-size: 20px;
          direction: rtl;
          padding: 20px; /* فاصله داخلی */
          background-color: var(--background-color);
          min-height: 100vh;
          color: var(--white-color);
          overflow: auto; /* اسکرول برای محتوای اضافی */
      }
      
        .container {
            max-width: 900px;
            margin: auto; /* مرکز کردن عنصر */
            background-color: var(--card-background);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); /* سایه ملایم */
            border-radius: 12px;
            padding: 50px;
            margin-top: 50px;
            transition: box-shadow 0.3s, transform 0.3s;
        }

        h1 {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 60px;
            color: var(--primary-color);
            font-size: 2 rem;
        }

        .form-group.label-input {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-bottom: 10px;
        }

        label {
            margin-right: 10px;
            flex: 1;
        }

         input, select, textarea {
            flex: 3;
            min-width: 0; /* برای جلوگیری از overflow */
            max-width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color); /* حاشیه */
            background-color: #333;
            font-family: 'Amiri', sans-serif;
            font-size: 20px;
            color: var(--white-color);
            transition: border-color 0.3s, box-shadow 0.3s; /* انیمیشن تغییر حاشیه و سایه */
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color); /* تغییر رنگ حاشیه در حالت تمرکز */
            outline: none; /* حذف حاشیه */
        }

        input:hover, select:hover, textarea:hover {
            box-shadow: 0 0 5px rgba(173, 216, 230, 0.8); /* سایه آبی روشن */
            border-color: var(--primary-color); /* تغییر رنگ حاشیه */
        }

        button {
            padding: 8px 10px;; /* فاصله داخلی در دکمه */
            background-color: transparent; /* بک گراند شفاف */
            color: var(--white-color); /* رنگ متن دکمه */
            border: 1px solid #4CAF50; /* حاشیه سفید */
            border-radius: 4px; 
            cursor: pointer; /* تغییر نشانگر ماوس */
            font-size: 20px;
            margin-top: 10px;
            margin-bottom: 20px;
            margin-right: 10px;
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Amiri', sans-serif;
        }

        button:hover {
            background-color: rgba(128, 128, 128, 0.3); /* تغییر رنگ پس‌زمینه در حالت hover */
            color: white;
        }

        .remove-btn {
            margin-top: 10px;
            background-color: transparent;
            color: var(--white-color);
        }

        .remove-btn:hover {
            background-color: rgba(255, 0, 0, 0.3);
            color: white;
        }

      
        .item {
            margin-top: 20px;
            padding: 10px; /* فاصله داخلی */
            border: 1px solid #ddd;
            border-color : #FFFFFF;
            border-radius: 6px;
            background-color: var(--item-background);
            font-family: 'Amiri', sans-serif;
            animation: fadeIn 0.3s ease-in;
        }
      
       .message-box {
            display: none;
            margin: auto;
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); /* سایه ملایم برای بهتر دیده شدن */
            transition: all 0.3s ease;
        }
      
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
      
      
         @media (max-width: 640px) {
            .container {
                padding: 15px; /* فاصله داخلی در نمایشگرهای کوچک */
            }

            h1 {
                font-size: 24px; /* اندازه عنوان در نمایشگرهای کوچک */
                margin-bottom: 30px;
            }
            button {
                font-size: 14px;
                padding: 8px;
            }
           .form-group.label-input {
                flex-direction: column; /* تغییر به ردیف عمودی */
            }

            input, select, textarea {
                width: 100%; /* ورودی‌ها به تمام عرض دسترسی می‌یابند */
                margin-bottom: 10px;
            }
        }
    </style>
</head>
</html>
<body>
    <div class="container"> 
        <h1>اطلاعات فاکتورها (دبستان)</h1> 
        <form id="invoiceForm">
            <div class="form-group label-input">
                <label for="invoice_number">شماره فاکتور:</label>
                <input type="number" id="invoice_number" placeholder=" لطفا اعداد را به انگلیسی وارد کنید." name="invoice_number" required>
            </div>
 

            <div class="form-group label-input">
    <label for="invoice_date">تاریخ فاکتور:</label>
    <input type="text" id="invoice_date" data-jdp placeholder=" تاریخ شمسی فاکتور را وارد کنید." data-jdp-only-date name="invoice_date">
    </div>

        
       
            <div class="form-group label-input">
                <label for="total_amount">بهای کل فاکتور:</label>
                <input type="number" id="total_amount" placeholder=" بهای کل فاکتور را به ریال  وارد کنید." name="total_amount" required>
            </div>

            <div id="itemsContainer"></div>
            <button type="button" onclick="addItem()">افزودن قلم کالا</button> 

            <div class="form-group label-input">
                <label for="supplier_details">مشخصات فروشنده:</label>
                <input type="text" id="supplier_details" name="supplier_details" required> 
            </div>
            <div class="form-group label-input">
                <label for="description">توضیحات:</label>
                <textarea id="description" name="description" rows="3"></textarea>
            </div>
            <button type="submit">ارسال</button>
            <input type="hidden" id="submitTimestamp" name="submitTimestamp">
          
            <div id="message" style="display: none;" class="message-box">
        </form>
    </div>
</div>
  
  
    <script>
        
      $(document).ready(function() { 
        jalaliDatepicker.startWatch({
          minDate: "attr",
          maxDate: "attr",
          time: true,
        });

        });

        let itemCount = 0;

        function addItem() {
            itemCount++;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';
            const itemNumber = itemCount; // استفاده از itemCount برای تعیین شماره قلم
            itemDiv.id = `item-${itemNumber}`;
           
            itemDiv.innerHTML = `
                <h5>قلم ${itemNumber}</h5>
                <div class="form-group label-input">
                    <label for="itemCount${itemNumber}">تعداد:</label>
                    <input type="number" id="itemCount${itemNumber}" name="itemCount${itemNumber}" required>
                </div>
                <div class="form-group label-input">
    <label style="margin-bottom:0;" for="level${itemNumber}">پایه:</label>
    <div id="levelGroup${itemNumber}" style="display:flex; gap:10px; flex-wrap:wrap;">
        <label style="display:flex;align-items:center;gap:3px;">
            <input type="checkbox" name="level${itemNumber}" value="اول">اول
        </label>
        <label style="display:flex;align-items:center;gap:3px;">
            <input type="checkbox" name="level${itemNumber}" value="دوم">دوم
        </label>
        <label style="display:flex;align-items:center;gap:3px;">
            <input type="checkbox" name="level${itemNumber}" value="سوم">سوم
        </label>
        <label style="display:flex;align-items:center;gap:3px;">
            <input type="checkbox" name="level${itemNumber}" value="چهارم">چهارم
        </label>
        <label style="display:flex;align-items:center;gap:3px;">
            <input type="checkbox" name="level${itemNumber}" value="پنجم">پنجم
        </label>
        <label style="display:flex;align-items:center;gap:3px;">
            <input type="checkbox" name="level${itemNumber}" value="ششم">ششم
        </label>
    </div>
</div>   
                <div class="form-group label-input">
                    <label for="invoice_type${itemNumber}">نوع فاکتور:</label>
                    <select id="invoice_type${itemNumber}" name="invoice_type${itemNumber}" onchange="toggleConditional(${itemNumber})" required>
                        <option value="">انتخاب کنید.</option>
                        <option value="تمام پایه">تمام پایه</option>
                        <option value="زیرگروه زبان">زیرگروه زبان</option>
                        <option value="فردی">فردی</option>
                    </select>
                </div>
                
                <div class="conditional" id="conditionalLanguage${itemNumber}" style="display: none;">
                    <div class="form-group label-input">
                        <label for="subgroup_language${itemNumber}">نام زیرگروه زبان:</label>
                        <select id="subgroup_language${itemNumber}" name="subgroup_language${itemNumber}">
                            <option value="">انتخاب کنید.</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                </div>
                
                <div class="conditional" id="conditionalnational_id${itemNumber}" style="display: none;">
                    <div class="form-group label-input">
                        <label for="national_id${itemNumber}">کد ملی ده رقمی دانش آموز:</label>
                        <input type="text" id="national_id${itemNumber}" name="national_id${itemNumber}" maxlength="10" pattern="\\d{10}" title="کد ملی باید ده رقم باشد">
                    </div>
                </div>
                
                <div class="form-group label-input">
                    <label for="itemCategory${itemNumber}">دسته‌بندی قلم کالا:</label>
                    <select id="itemCategory${itemNumber}" name="itemCategory${itemNumber}" onchange="toggleItemDetails(${itemNumber})" required>
                        <option value="">انتخاب کنید.</option>
                        <option value="ملزومات آموزشی">ملزومات آموزشی</option>
                        <option value="آزمون/کلوپ/مسابقات">آزمون/کلوپ/مسابقات</option>
                        <option value="خدمات">خدمات</option>
                        <option value="انجمن">انجمن</option>
                        <option value="آژانس/اردو">آژانس/اردو</option>
                    </select>
                </div>
                
                <div class="conditionalItemDetails" id="conditionalItemDetails${itemCount}" style="display: none;">
                    <div class="form-group label-input">
                        <label for="sub_code${itemNumber}">دسته‌بندی فرعی کالا:</label>
                        <select id="sub_code${itemNumber}" name="sub_code${itemNumber}" required>
                            <option value="">انتخاب کنید.</option>
                                                        <option value="لوازم التحریر">لوازم التحریر</option>
                                                        <option value="کتاب">کتاب</option>
                                                        <option value="چاپ و تکثیر">چاپ و تکثیر</option>
                                                        <option value="آزمون">آزمون</option>
                                                        <option value="کلوپ علمی متوسطه یک">کلوپ علمی متوسطه یک</option>
                                                        <option value="کلوپ هنری متوسطه یک">کلوپ هنری متوسطه یک</option>
                                                        <option value="مسابقات">مسابقات</option>
                                                        <option value="خدمات کارگاه هنر">خدمات کارگاه هنر</option>
                                                        <option value="خدمات آزمايشگاه ">خدمات آزمايشگاه </option>
                                                        <option value="خدمات سرو">خدمات سرو</option>
                                                        <option value="خدمات جشن">خدمات جشن</option>
                                                        <option value="خدمات خیاطی">خدمات خیاطی</option>
                                                        <option value="خدمات عکاسی">خدمات عکاسی</option>
                                                        <option value="بیمه دانش آموزی">بیمه دانش آموزی</option>
                                                        <option value="ابزار الکتریکی">ابزار الکتریکی</option>
                                                        <option value="باغبانی و کشاورزی">باغبانی و کشاورزی</option>
                                                        <option value="عروسک">عروسک</option>
                                                        <option value="فیزیک">فیزیک</option>
                                                        <option value="زیست">زیست</option>
                                                        <option value="شیمی">شیمی</option>
                                                        <option value="عکاسی">عکاسی</option>
                                                        <option value="کامپیوتر">کامپیوتر</option>
                                                        <option value="نمایش">نمایش</option>
                                                        <option value="روانشناسی">روانشناسی</option>
                                                        <option value="اردو درون شهری تفریحی">اردو درون شهری تفریحی</option>
                                                        <option value="اردو درون شهری علمی آموزشی">اردو درون شهری علمی آموزشی</option>
                                                        <option value="اردو برون شهری">اردو برون شهری</option>
                                                        <option value="آژانس">آژانس</option>
                        </select>
                    </div>
                    
                    <div class="form-group label-input">
                        <label for="detail_code${itemNumber}">دسته‌بندی تفصیلی کالا:</label>
                        <select id="detail_code${itemNumber}" name="detail_code${itemNumber}" onchange="handleOtherDetail(${itemNumber})" required>
                            <option value="">انتخاب کنید.</option>
                                                        <option value="کتاب تخصصی">کتاب تخصصی</option>
                                                        <option value="کتاب درسی">کتاب درسی</option>
                                                        <option value="کتاب زبان خارجه انگلیسی">کتاب زبان خارجه انگلیسی</option>
                                                        <option value="کتاب زبان خارجه فرانسه">کتاب زبان خارجه فرانسه</option>
                                                        <option value="کتاب زبان خارجه آلمانی">کتاب زبان خارجه آلمانی</option>
                                                        <option value="کمک درسی خیلی سبز عربی">کمک درسی خیلی سبز عربی</option>
                                                        <option value="کمک درسی">کمک درسی</option>
                                                        <option value="داستان">داستان</option>
                                                        <option value="فلش کارت">فلش کارت</option>
                                                        <option value="مجله">مجله</option>
                                                        <option value="کاغذ">کاغذ</option>
                                                        <option value="لوازم کاردستی/هنری">لوازم کاردستی/هنری</option>
                                                        <option value="دفتر">دفتر</option>
                                                        <option value="پوشه کاغذی خرد/کلربوک">پوشه کاغذی خرد/کلربوک</option>
                                                        <option value="نوشت افزار">نوشت افزار</option>
                                                        <option value="بگ/ساک">بگ/ساک</option>
                                                        <option value="کوله پشتی">کوله پشتی</option>
                                                        <option value="چاپ و تکثیر">چاپ و تکثیر</option>
                                                        <option value="صحافی">صحافی</option>
                                                        <option value="آزمون خیلی سبز">آزمون خیلی سبز</option>
                                                        <option value="آزمون سنجش">آزمون سنجش</option>
                                                        <option value="آزمون گزینه دو">آزمون گزینه دو</option>
                                                        <option value="آزمون منتا">آزمون منتا</option>
                                                        <option value="آزمون میدیا">آزمون میدیا</option>
                                                        <option value="ادبیات">ادبیات</option>
                                                        <option value="ریاضی">ریاضی</option>
                                                        <option value="زیست">زیست</option>
                                                        <option value="شیمی">شیمی</option>
                                                        <option value="فیزیک">فیزیک</option>
                                                        <option value="انیمیشن">انیمیشن</option>
                                                        <option value="تصویرسازی">تصویرسازی</option>
                                                        <option value="سرامیک">سرامیک</option>
                                                        <option value="طراحی لباس">طراحی لباس</option>
                                                        <option value="طراحی نقاشی">طراحی نقاشی</option>
                                                        <option value="عکاسی">عکاسی</option>
                                                        <option value="گرافیک">گرافیک</option>
                                                        <option value="گرافیک دیجیتال">گرافیک دیجیتال</option>
                                                        <option value="نمایش">نمایش</option>
                                                        <option value="مسابقات کتابخوانی">مسابقات کتابخوانی</option>
                                                        <option value="صبحانه/ناهار">صبحانه/ناهار</option>
                                                        <option value="ساندویج">ساندویج</option>
                                                        <option value="شیرینی،کیک، شکلات">شیرینی،کیک، شکلات</option>
                                                        <option value="نوشیدنی">نوشیدنی</option>
                                                        <option value="فارغ التحصیلی">فارغ التحصیلی</option>
                                                        <option value="جشن مناسبتی">جشن مناسبتی</option>
                                                        <option value="عکس پرسنلی">عکس پرسنلی</option>
                                                        <option value="عکس گروهی">عکس گروهی</option>
                                                        <option value="گل">گل</option>
                                                        <option value="گلدان">گلدان</option>
                                                        <option value="بذر">بذر</option>
                                                        <option value="خاک و پوکه">خاک و پوکه</option>
                                                        <option value="اردوگاه چمران">اردوگاه چمران</option>
                                                        <option value="تئاتر/سینما">تئاتر/سینما</option>
                                                        <option value="موزه">موزه</option>
                                                        <option value="دیجی کالا">دیجی کالا</option>
                                                        <option value="باغ نگارستان">باغ نگارستان</option>
                                                        <option value="سایر">سایر</option>
                        </select>
        
         <input type="text" class="form-control mt-2" id="other_detail_code${itemNumber}" name="other_detail_code${itemNumber}" placeholder="لطفاً مشخصات دیگر را وارد کنید" style="display: none;">
                </div>
               </div>
                
                <div class="form-group label-input">
                    <label for="unit_price${itemNumber}">بهای واحد (ریال):</label>
                    <input type="number" id="unit_price${itemNumber}" name="unit_price${itemNumber}" required>
                </div>
                <button type="button" class="remove-btn" onclick="removeItem(${itemNumber})">حذف قلم کالا</button>
            `;
            document.getElementById('itemsContainer').appendChild(itemDiv);
        }

        function removeItem(itemNumber) {
            const itemDiv = document.getElementById(`item-${itemNumber}`);
            if (itemDiv) {
                itemDiv.remove();
                updateItemNumbers();
            }
        }

        function updateItemNumbers() {
            const items = document.querySelectorAll('.item');
            itemCount = items.length;

            items.forEach((item, index) => {
                const itemNumber = index + 1;
                item.id = `item-${itemNumber}`;
                item.querySelector('h5').innerText = `قلم ${itemNumber}`;
                item.querySelector('input[type="number"]').id = `itemCount${itemNumber}`;
                item.querySelector('input[type="number"]').name = `itemCount${itemNumber}`;
                item.querySelector('select').id = `level${itemNumber}`;
                item.querySelector('select').name = `level${itemNumber}`;
                item.querySelector('.remove-btn').setAttribute('onclick', `removeItem(${itemNumber})`);
            });
        }

function toggleConditional(itemNumber) {
            const invoice_type = document.getElementById(`invoice_type${itemNumber}`).value;
            const languageDiv = document.getElementById(`conditionalLanguage${itemNumber}`);
            const national_idDiv = document.getElementById(`conditionalnational_id${itemNumber}`);

            // Reset visibility and values
            languageDiv.style.display = 'none';
            national_idDiv.style.display = 'none';
            document.getElementById(`national_id${itemNumber}`).value = ""; // Reset National ID when the type changes
            document.getElementById(`subgroup_language${itemNumber}`).value = ""; // <-- fix id here

            if (invoice_type === 'زیرگروه زبان') {
                languageDiv.style.display = 'block';
            }
            if (invoice_type === 'فردی') {
                national_idDiv.style.display = 'block';
            }
            // If both are needed (for future logic)
            if (invoice_type === 'زیرگروه زبان' || invoice_type === 'فردی') {
                if (invoice_type === 'زیرگروه زبان') languageDiv.style.display = 'block';
                if (invoice_type === 'فردی') national_idDiv.style.display = 'block';
            }
        }
      
         function toggleItemDetails(itemNumber) { 
                        const category = document.getElementById(`itemCategory${itemNumber}`).value;
                        const conditionalItemDetails = document.getElementById(`conditionalItemDetails${itemNumber}`);
                        const sub_codeSelect = document.getElementById(`sub_code${itemNumber}`);
                        const detailCodeSelect = document.getElementById(`detail_code${itemNumber}`);
                        const otherDetailInput = document.getElementById(`other_detail_code${itemNumber}`);

                        if (category === 'ملزومات آموزشی') {
                                sub_codeSelect.innerHTML = `
                                        <option value="">انتخاب کنید</option>
                                        <option value="کتاب">کتاب</option>
                                        <option value="لوازم‌ التحریر">لوازم‌ التحریر</option>
                                        <option value="ابزار یادگیری">ابزار یادگیری</option>
                                        <option value="چاپ و تکثیر">چاپ و تکثیر</option>
                                        
                                `;
                                detailCodeSelect.innerHTML = `
                                <option value="">انتخاب کنید</option>
                              `;
                             conditionalItemDetails.style.display = 'block';
                
                        // افزودن event listener برای تغییر sub_codeSelect
                            sub_codeSelect.addEventListener('change', function() {
                                const selectedsub_code = sub_codeSelect.value;
                                if (selectedsub_code === 'کتاب') {
                                	      detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید.</option>
                                                <option value="کتاب تخصصی">کتاب تخصصی</option>
                                                <option value="کتاب درسی">کتاب درسی</option>
                                                <option value="کتاب زبان خارجه انگلیسی">کتاب زبان خارجه انگلیسی</option>
                                                <option value="کتاب زبان خارجه فرانسه">کتاب زبان خارجه فرانسه</option>
                                                <option value="کتاب زبان خارجه آلمانی">کتاب زبان خارجه آلمانی</option>
                                                <option value="کمک درسی">کمک درسی</option>
                                                <option value="کمک درسی خیلی سبز عربی">کمک درسی خیلی سبز عربی</option>
                                                <option value="داستان">داستان</option>
                                                <option value="فلش کارت">فلش کارت</option>
                                                <option value="مجله">مجله</option>
                                                <option value="سایر">سایر</option>
                                      `;
                              } else if (selectedsub_code === 'لوازم‌ التحریر') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید.</option>
                                                <option value="کاغذ">کاغذ</option>
                                                <option value="لوازم کاردستی/هنری">لوازم کاردستی/هنری</option>
                                                <option value="دفتر">دفتر</option>
                                                <option value="پوشه کاغذی خرد/کلربوک">پوشه کاغذی خرد/کلربوک</option>
                                                <option value="نوشت افزار">نوشت افزار</option>
                                                <option value="بگ/ساک">بگ/ساک</option>
                                                <option value="کوله پشتی">کوله پشتی</option>
                                                <option value="سایر">سایر</option>
                                                `;
                               } else if (selectedsub_code === 'ابزار یادگیری') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید.</option>
                                                <option value="ابزار الکتریکی">ابزار الکتریکی</option>
                                                <option value="باغبانی و کشاورزی (بذر)">باغبانی و کشاورزی (بذر)</option>
                                                <option value="باغبانی و کشاورزی (خاک و پوکه)">باغبانی و کشاورزی (خاک و پوکه)</option>
                                                <option value="باغبانی و کشاورزی (گل)">باغبانی و کشاورزی (گل)</option>
                                                <option value="باغبانی و کشاورزی (گلدان)">باغبانی و کشاورزی (گلدان)</option>
                                                <option value="سایر">سایر</option>
                                                `;
                              } else if (selectedsub_code === 'چاپ و تکثیر') {
                                        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید.</option>
                                                <option value="چاپ و تکثیر">چاپ و تکثیر</option>
                                                <option value="صحافی">صحافی</option>
                                                <option value="سایر">سایر</option>
                                                `;
                              }
                        });
                        
                        } else if (category === 'آزمون/کلوپ/مسابقات') {
                                sub_codeSelect.innerHTML = `
                                        <option value="">انتخاب کنید.</option>
                                        <option value="آزمون">آزمون</option>
                                        <option value="کلوپ علمی متوسطه یک">کلوپ علمی متوسطه یک</option>
                                        <option value="کلوپ هنری متوسطه یک">کلوپ هنری متوسطه یک</option>
                                        <option value="مسابقات">مسابقات</option>
                                `;
                                  detailCodeSelect.innerHTML = `
                                <option value="">انتخاب کنید</option>
                              `;
                             conditionalItemDetails.style.display = 'block';
                
                        // افزودن event listener برای تغییر sub_codeSelect
                            sub_codeSelect.addEventListener('change', function() {
                                const selectedsub_code = sub_codeSelect.value;     
                                if (selectedsub_code === 'آزمون') {
	                                detailCodeSelect.innerHTML = `
	                                        <option value="">انتخاب کنید</option>
	                                        <option value="آزمون خیلی سبز">آزمون خیلی سبز</option>
	                                        <option value="آزمون سنجش">آزمون سنجش</option>
	                                        <option value="آزمون گزینه دو">آزمون گزینه دو</option>
	                                        <option value="آزمون منتا">آزمون منتا</option>
	                                        <option value="آزمون میدیا">آزمون میدیا</option>
	                                        <option value="سایر">سایر</option>
                                 `;  
                                 } else if (selectedsub_code === 'کلوپ علمی متوسطه یک') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="ادبیات">ادبیات</option>
	                                    <option value="ریاضی">ریاضی</option>
	                                     <option value="زیست">زیست</option>
	                                    <option value="شیمی">شیمی</option>
	                                    <option value="فیزیک">فیزیک</option>
                                                <option value="سایر">سایر</option>
                                                `;
                                      } else if (selectedsub_code === 'کلوپ هنری متوسطه یک') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="انیمیشن">انیمیشن</option>
                                <option value="تصویرسازی">تصویرسازی</option>
                                <option value="سرامیک">سرامیک</option>
                                <option value="طراحی لباس">طراحی لباس</option>
                                <option value="طراحی نقاشی">طراحی نقاشی</option>
                                <option value="عکاسی">عکاسی</option>
                                <option value="گرافیک">گرافیک</option>
                                <option value="گرافیک دیجیتال">گرافیک دیجیتال</option>
                                <option value="نمایش">نمایش</option>
                                                <option value="سایر">سایر</option>
                                                `;
                                               
                                      } else if (selectedsub_code === 'مسابقات') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="مسابقات کتابخوانی">مسابقات کتابخوانی</option>
                                                <option value="سایر">سایر</option>
                                                `;
                              }
                        });
                                
                        } else if (category === 'خدمات') {
                                sub_codeSelect.innerHTML = `
                                        <option value="">انتخاب کنید</option>
                                        <option value="خدمات کارگاه هنر">خدمات کارگاه هنر</option>
                                        <option value="خدمات آزمايشگاه">خدمات آزمايشگاه</option>
                                        <option value="خدمات سرو">خدمات سرو</option>
                                        <option value="خدمات جشن">خدمات جشن</option>
                                        <option value="خدمات خیاطی">خدمات خیاطی</option>
                                        <option value="خدمات عکاسی">خدمات عکاسی</option>
                                        <option value="بیمه دانش آموزی">بیمه دانش آموزی</option>
                                `;
                                
                                detailCodeSelect.innerHTML = `
                                <option value="">انتخاب کنید</option>
                              `;
                              conditionalItemDetails.style.display = 'block';
                
                        // افزودن event listener برای تغییر sub_codeSelect
                            sub_codeSelect.addEventListener('change', function() {
                                const selectedsub_code = sub_codeSelect.value;
                                if (selectedsub_code === 'خدمات کارگاه هنر') {
	                                detailCodeSelect.innerHTML = `
	                                <option value="">انتخاب کنید</option>
	                                <option value="none">توضیحات بیشتری ندارد.</option>
	                                <option value="سایر">سایر</option>
                                `;
                                } else if (selectedsub_code === 'خدمات آزمايشگاه') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="زیست">زیست</option>
	                                    <option value="شیمی">شیمی</option>
	                                    <option value="فیزیک">فیزیک</option>
                                                <option value="سایر">سایر</option>
                                                `;
                                 } else if (selectedsub_code === 'خدمات سرو') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="صبحانه/ناهار">صبحانه/ناهار</option>
                                             <option value="ساندویج">ساندویج</option>
                                             <option value="شیرینی،کیک، شکلات">شیرینی،کیک، شکلات</option>
                                             <option value="نوشیدنی">نوشیدنی</option>
                                                <option value="سایر">سایر</option>
                                                `;
                                  } else if (selectedsub_code === 'خدمات جشن') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="فارغ التحصیلی">فارغ التحصیلی</option>
                                             <option value="جشن مناسبتی">جشن مناسبتی</option>
                                                <option value="سایر">سایر</option>
                                                `;
                                    } else if (selectedsub_code === 'خدمات خیاطی') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="none">توضیحات بیشتری ندارد.</option>
                                                <option value="سایر">سایر</option>
                                                `;
                                    } else if (selectedsub_code === 'خدمات عکاسی') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="عکس پرسنلی">عکس پرسنلی</option>
                                             <option value="عکس گروهی">عکس گروهی</option>
                                                <option value="سایر">سایر</option>
                                                `;
                                    } else if (selectedsub_code === 'بیمه دانش آموزی') {
                              	        detailCodeSelect.innerHTML = `
                                                <option value="">انتخاب کنید</option>
                                                <option value="none">توضیحات بیشتری ندارد.</option>
                                                <option value="سایر">سایر</option>
                                                `;
                              }
                        });
                                
                        } else if (category === 'انجمن') {
                                sub_codeSelect.innerHTML = `
                                        <option value="">انتخاب کنید</option>
                                        <option value="فیزیک">فیزیک</option>
                                        <option value="زیست">زیست</option>
                                        <option value="شیمی">شیمی</option>
                                        <option value="عکاسی">عکاسی</option>
                                        <option value="کامپیوتر">کامپیوتر</option>
                                        <option value="نمایش">نمایش</option>
                                        <option value="روانشناسی">روانشناسی</option>
                                `;
                                
                                detailCodeSelect.innerHTML = `
                                <option value="">انتخاب کنید</option>
                                <option value="none">توضیحات بیشتری ندارد.</option>
                                 <option value="سایر">سایر</option>
                              `;
                              conditionalItemDetails.style.display = 'block';
                
                        } else if (category === 'آژانس/اردو') {
                                sub_codeSelect.innerHTML = `
                                        <option value="">انتخاب کنید</option>
                                        <option value="اردو درون شهری تفریحی">اردو درون شهری تفریحی</option>
                                        <option value="اردو درون شهری علمی آموزشی">اردو درون شهری علمی آموزشی</option>
                                        <option value="اردو برون شهری">اردو برون شهری</option>
                                        <option value="آژانس">آژانس</option>
                                `;
                                
                                detailCodeSelect.innerHTML = `
                                <option value="">انتخاب کنید</option>
                              `;
                              conditionalItemDetails.style.display = 'block';
                
                        // افزودن event listener برای تغییر sub_codeSelect
                            sub_codeSelect.addEventListener('change', function() {
                                const selectedsub_code = sub_codeSelect.value;
                                if (selectedsub_code === 'آژانس') {
                                	detailCodeSelect.innerHTML = `
                                        <option value="">انتخاب کنید</option>
                                        <option value="none">توضیحات بیشتری ندارد.</option>
                                        <option value="سایر">سایر</option>
                                `;
                                } else if (selectedsub_code === 'اردو درون شهری تفریحی') {
                                detailCodeSelect.innerHTML = `
                                        <option value="">انتخاب کنید</option>
                                        <option value="اردوگاه چمران">اردوگاه چمران</option>
                                        <option value="تئاتر/سینما">تئاتر/سینما</option>
                                        <option value="موزه">موزه</option>
                                        <option value="دیجی کالا">دیجی کالا</option>
                                        <option value="باغ نگارستان">باغ نگارستان</option>
                                        <option value="سایر">سایر</option>
                                `;
                     		   } else if (selectedsub_code === 'اردو درون شهری علمی آموزشی') {
                                detailCodeSelect.innerHTML = `
                                        <option value="">انتخاب کنید</option>
                                        <option value="اردوگاه چمران">اردوگاه چمران</option>
                                        <option value="تئاتر/سینما">تئاتر/سینما</option>
                                        <option value="موزه">موزه</option>
                                        <option value="دیجی کالا">دیجی کالا</option>
                                        <option value="باغ نگارستان">باغ نگارستان</option>
                                        <option value="سایر">سایر</option>
                                `;} else if (selectedsub_code === 'اردو برون شهری') {
                                detailCodeSelect.innerHTML = `
                                        <option value="">انتخاب کنید</option>
                                        <option value="اردوگاه چمران">اردوگاه چمران</option>
                                        <option value="تئاتر/سینما">تئاتر/سینما</option>
                                        <option value="موزه">موزه</option>
                                        <option value="دیجی کالا">دیجی کالا</option>
                                        <option value="باغ نگارستان">باغ نگارستان</option>
                                        <option value="سایر">سایر</option>
                                `; }
                        });
		}
                        otherDetailInput.style.display = "none"; // مخفی کردن ورودی سایر
                }
      
 // Helper to get CSRF token cookie (needed for Django POST)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function handleOtherDetail(itemNumber) {
    const detail_code = document.getElementById(`detail_code${itemNumber}`).value;
    const otherDetailInput = document.getElementById(`other_detail_code${itemNumber}`);

    if (!otherDetailInput) return;  // safety check

    otherDetailInput.style.display = "none";

    if (detail_code === "سایر") {
        otherDetailInput.style.display = "block";
    }
}

function showTemporaryMessage(message) {
    const messageDiv = document.getElementById('message');
    messageDiv.innerText = message;
    messageDiv.style.display = 'block'; // نمایش پیام
    messageDiv.style.animation = 'fadeIn 0.3s ease'; // افزودن انیمیشن

    // بعد از 5 ثانیه، پیام پنهان می‌شود
    setTimeout(() => {
        messageDiv.style.display = 'none'; // پنهان کردن پیام
    }, 5000);
}

function resetForm() {
    document.getElementById('invoiceForm').reset();
    document.getElementById('itemsContainer').innerHTML = '';
    itemCount = 0;
}

document.getElementById('invoiceForm').addEventListener('submit', function(event) {
    event.preventDefault();

    // ثبت تاریخ و ساعت کنونی
    const currentDate = new Date();
    const formattedDate = `${currentDate.toLocaleDateString('fa-IR')} ${currentDate.toLocaleTimeString('fa-IR')}`;
    document.getElementById('submitTimestamp').value = formattedDate; // ثبت در فیلد پنهان

    const submitButton = document.querySelector('button[type="submit"]');

    // تغییر رنگ دکمه ارسال به خاکستری و غیر فعال کردن آن
    submitButton.style.backgroundColor = 'gray';
    submitButton.disabled = true;

    // نمایش پیام انتظار
    showTemporaryMessage('لطفا برای ثبت اطلاعات فاکتور منتظر بمانید!');

    const formData = new FormData(this);
    const invoice_number = document.getElementById('invoice_number').value;
    const nationalIDs = [...document.querySelectorAll('input[id^="nationalID"]')].map(input => input.value);
    const invoice_type = document.querySelector('select[name^="invoice_type"]').value;

    const isInvoice_numberValid = /^[a-zA-Z0-9]+$/.test(invoice_number);
    if (!isInvoice_numberValid) {
        alert('شماره فاکتور باید فقط به انگلیسی باشد.');
        submitButton.style.backgroundColor = ''; // بازگشت رنگ دکمه به حالت اولیه
        submitButton.disabled = false; // فعال کردن دکمه
        return;
    }

    if (invoice_type === 'فردی') {
        const isNationalIDValid = nationalIDs.every(id => /^\d{10}$/.test(id));
        if (!isNationalIDValid) {
            alert('کد ملی هر دانش آموز باید یک عدد ۱۰ رقمی باشد.');
            submitButton.style.backgroundColor = ''; // بازگشت رنگ دکمه به حالت اولیه
            submitButton.disabled = false; // فعال کردن دکمه
            return;
        }
    }

    // document.getElementById('invoiceForm').addEventListener('submit', function(event) {
    // event.preventDefault();
    // // ...existing code...

//     const formData = new FormData(this);

// const formData = new FormData(this);

//     // Build items array
    const items = [];
    for (let i = 1; i <= itemCount; i++) {
        if (document.getElementById(`itemCount${i}`)) {
            const levelCheckboxes = document.querySelectorAll(`input[name="level${i}"]:checked`);
            const selectedLevels = Array.from(levelCheckboxes).map(cb => cb.value);
            
            items.push({
                count: formData.get(`itemCount${i}`),
                level: selectedLevels, // now an array
                invoice_type: formData.get(`invoice_type${i}`),
                subgroup_language: formData.get(`subgroup_language${i}`),
                national_id: formData.get(`national_id${i}`),
                category: formData.get(`itemCategory${i}`),
                sub_code: formData.get(`sub_code${i}`),
                detail_code: formData.get(`detail_code${i}`),
                other_detail_code: formData.get(`other_detail_code${i}`),
                unit_price: formData.get(`unit_price${i}`)
            });
        }
    }


    let invoice_date = formData.get('invoice_date');
    if (invoice_date) {
        invoice_date = invoice_date.replace(/\//g, '-');
    }

    let submitTimestamp = formData.get('submitTimestamp');
    if (submitTimestamp) {
        submitTimestamp = toEnglishDigits(submitTimestamp).replace(/\//g, '-');
    }

    const formJSON = {
        invoice_number: formData.get('invoice_number'),
        invoice_date: invoice_date,
        total_amount: formData.get('total_amount'),
        supplier_details: formData.get('supplier_details'),
        description: formData.get('description'),
        items: items,
        submitTimestamp: submitTimestamp
    };

    // Debug: check JSON before sending
    console.log(JSON.stringify(formJSON));

    fetch('/api/submit-invoice/', {
        method: 'POST',
        headers: {
            'Content-Type': "application/json; charset=utf-8",
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify(formJSON),
    })
    .then(response => {
        if (response.ok) {
            alert('اطلاعات فاکتور با موفقیت ثبت شد!');
            resetForm();
        } else {
            alert('خطا در ارسال اطلاعات، لطفا دوباره تلاش کنید.');
        }
    })
    .catch(error => {
        alert('خطا در ارسال اطلاعات: ' + error.message);
    })
    .finally(() => {
        submitButton.style.backgroundColor = '';
        submitButton.disabled = false;
    });
});


function toEnglishDigits(str) {
    if (!str) return str;
    return str.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d))
              .replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
}

</script>

</body>
</html>
